<script setup lang="ts">
    // Page: {{ properCase name }}
    definePageMeta({ layout: 'default' })

    // Composables
    const { t } = useI18n()
    const { $civicApi } = useNuxtApp()

    // Route & simple state (swap for your actual permission system)
    const page = ref(1)
    const pageSize = ref(20)
    const canManage = computed(() => true) // TODO: wire permissions

    // Data loading (SSR-friendly)
    type Item = { id: string | number; name?: string; username?: string; email?: string; role?: string; created_at?: string }
    const { data, pending: loading, error, refresh } = await useAsyncData(
        'list-{{ kebabCase name }}',
        () => $civicApi('/api/v1/{{ kebabCase name }}', { params: { page: page.value, pageSize: pageSize.value } }) as Promise<{ success: boolean; data: Item[]; error?: string }>,
        { default: () => ({ success: true, data: [] }) }
    )

    // Normalized list + error text
    const items = computed < Item[] > (() => (data.value?.data ?? []))
    const errorText = computed(() => (data.value && 'success' in data.value && !data.value.success ? (data.value.error ?? t('common.errors.fetchFailed')) : (error.value as any)?.message))

    // Refresh when page changes
    watch([page, pageSize], () => refresh())

    // UI helpers (provide safe fallbacks if your project lacks these utilities)
    function navigateToItem(item: Item) {
        return navigateTo(`/{{ kebabCase name }}/${item.id}`)
    }
    function getRoleColor(role?: string) {
        return role === 'admin' ? 'primary' : role === 'editor' ? 'amber' : 'gray'
    }
    function getRoleDisplayName(role?: string) {
        return role ? role.charAt(0).toUpperCase() + role.slice(1) : t('common.labels.unknown')
    }
    function formatDate(iso: string) {
        try { return new Date(iso).toLocaleDateString() } catch { return '' }
    }

    // Breadcrumbs (customize as needed)
    const breadcrumbItems = computed(() => [
        { label: t('nav.home'), to: '/' },
        { label: t('nav.admin'), to: '/admin' },
        { label: t('entities.{{ kebabCase name }}'), to: '/{{ kebabCase name }}' }
    ])
</script>

<template>
    <!-- CivicPress standard page layout with dashboard and accessible landmarks -->
    <UDashboardPanel>
        <template #header>
            <UDashboardNavbar id="{{ kebabCase name }}">
                <template #title>
                    <h1 class="text-lg font-semibold">
                        {{ t('entities.{{ kebabCase name }}') }}
                    </h1>
                </template>
                <template #description>
                    {{ t('entities.manageRecords', { entity: t('entities.{{ kebabCase name }}') }) }}
                </template>
                <template #right>
                    <!-- Guard slot if HeaderActions not present -->
                    <HeaderActions v-if="canManage"
                        :actions="[{ label: t('actions.newEntity', { entity: t('entities.{{ kebabCase name }}') }), color: 'primary' }]" />
                </template>
            </UDashboardNavbar>
        </template>

        <template #body>
            <UBreadcrumb :items="breadcrumbItems" class="mb-4" />

            <!-- Loading state -->
            <div v-if="loading" class="space-y-4" aria-busy="true" aria-live="polite">
                <!-- Fallback skeletons; render generic blocks if your project lacks UserCardSkeleton -->
                <UserCardSkeleton v-for="i in 3" :key="i" />
            </div>

            <!-- Error state -->
            <UAlert v-else-if="errorText" :title="errorText" color="error" variant="soft" class="mb-6"
                aria-live="assertive" />

            <!-- Data list -->
            <div v-else-if="items.length > 0" class="space-y-4">
                <UCard v-for="item in items" :key="item.id"
                    class="cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"
                    @click="navigateToItem(item)">
                    <div class="p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="flex-shrink-0">
                                    <!-- Fallback if UserAvatar is absent -->
                                    <UserAvatar v-if="$components?.UserAvatar" :user="item" size="lg" />
                                    <div v-else class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700" />
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                        {{ item.name || item.username || t('common.labels.untitled') }}
                                    </h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        {{ item.email || item.username || 'â€”' }}
                                    </p>
                                    <div class="flex items-center gap-2 mt-2">
                                        <UBadge :color="getRoleColor(item.role) as any" variant="soft" size="sm">
                                            {{ getRoleDisplayName(item.role) }}
                                        </UBadge>
                                        <span class="text-xs text-gray-500">
                                            {{ t('common.labels.createdOn', { date: formatDate(item.created_at || '') })
                                            }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <UIcon name="i-lucide-chevron-right" class="w-5 h-5 text-gray-400" />
                        </div>
                    </div>
                </UCard>

                <!-- Basic pagination (optional) -->
                <div class="flex items-center justify-end gap-2 pt-2">
                    <UButton :disabled="page <= 1" @click="page--">{{ t('common.actions.prev') }}</UButton>
                    <UButton variant="soft" @click="page++">{{ t('common.actions.next') }}</UButton>
                </div>
            </div>

            <!-- Empty state -->
            <div v-else class="text-center py-12">
                <UIcon name="i-lucide-users" class="w-16 h-16 text-gray-400 mx-auto mb-4" />
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                    {{ t('empty.noEntities', { entity: t('entities.{{ kebabCase name }}') }) }}
                </h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6">
                    {{ t('empty.noneCreatedYet', { entity: t('entities.{{ kebabCase name }}') }) }}
                </p>
                <UButton v-if="canManage" :to="`/{{ kebabCase name }}/new`" icon="i-lucide-plus" color="primary">
                    {{ t('actions.addFirst', { entity: t('entities.{{ kebabCase name }}') }) }}
                </UButton>
            </div>
        </template>
    </UDashboardPanel>
</template>